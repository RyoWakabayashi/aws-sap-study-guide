# 災害復旧

<!-- 
Copyright (c) 2025 AWS SAP Study Guide
Licensed under the MIT License. See LICENSE file for details.
-->

## 目次

1. [災害復旧の基本概念](#災害復旧の基本概念)
2. [災害復旧戦略](#災害復旧戦略)
3. [バックアップ戦略](#バックアップ戦略)
4. [高可用性設計](#高可用性設計)
5. [マルチリージョン設計](#マルチリージョン設計)
6. [災害復旧の実装パターン](#災害復旧の実装パターン)
7. [AWS Elastic Disaster Recovery](#aws-elastic-disaster-recovery)

---

## 災害復旧の基本概念

### RTO と RPO

RTO (Recovery Time Objective)

- **定義**: システム復旧までの目標時間
- **ビジネス影響**: ダウンタイムによる損失
- **コスト関係**: 短いRTOほど高コスト
- **測定**: 障害発生から完全復旧まで

RPO (Recovery Point Objective)

- **定義**: データ損失許容時間
- **ビジネス影響**: データ損失による影響
- **バックアップ頻度**: RPOがバックアップ間隔を決定
- **測定**: 最後のバックアップから障害発生まで

RTO/RPO の関係

- **トレードオフ**: 短い目標値ほど高コスト
- **ビジネス要件**: 業務の重要度による設定
- **技術選択**: 目標値に応じた技術・アーキテクチャ選択
- **継続的見直し**: ビジネス変化に応じた調整

### 災害の種類と影響

自然災害

- **地震**: データセンター物理的損傷
- **洪水**: 電力・通信インフラ障害
- **台風**: 広域停電、アクセス困難
- **対策**: 地理的分散、物理的冗長性

技術的障害

- **ハードウェア障害**: サーバー、ストレージ故障
- **ソフトウェア障害**: OS、アプリケーション不具合
- **ネットワーク障害**: 通信断絶、性能劣化
- **対策**: 冗長化、自動フェイルオーバー

人的要因

- **操作ミス**: 誤削除、設定ミス
- **セキュリティ侵害**: サイバー攻撃、内部不正
- **プロセス不備**: 手順書不備、訓練不足
- **対策**: 自動化、アクセス制御、教育

### ビジネス継続性計画 (BCP)

BCP の要素

- **ビジネス影響分析**: 業務停止による影響評価
- **リスク評価**: 災害発生確率と影響度
- **復旧戦略**: 業務継続のための戦略
- **実行計画**: 具体的な復旧手順

優先度設定

- **ミッションクリティカル**: 即座の復旧が必要
- **ビジネスクリティカル**: 数時間以内の復旧
- **重要**: 1日以内の復旧
- **一般**: 数日以内の復旧

---

## 災害復旧戦略

AWSでは、災害復旧戦略を以下の4つのカテゴリに分類しています：

1. **バックアップ＆リストア**:
   - 最も基本的な戦略で、データを定期的にバックアップし、災害時に復元します。
   - コスト効率が高いが、復旧時間が長くなる可能性があります。

2. **パイロットライト**:
   - 最小限のリソースを維持し、災害時に迅速に拡張します。
   - RTOとRPOが中程度で、コストと可用性のバランスが取れています。

3. **ウォームスタンバイ**:
   - 縮小版の環境を常時稼働させ、災害時にスケールアップします。
   - RTOとRPOが短く、ミッションクリティカルなアプリケーションに適しています。

4. **マルチサイトアクティブ**:
   - 複数のリージョンで完全な環境を稼働させ、災害時に切り替えます。
   - RTOとRPOが最短で、コストが高いですが高可用性を提供します。

---

## バックアップ戦略

AWSのバックアップ戦略には以下が含まれます：

- **Amazon S3**: データの長期保存に最適。
- **AWS Backup**: 複数のAWSサービスのバックアップを一元管理。
- **Amazon RDS**: 自動バックアップとスナップショット機能。

### バックアップの種類

フルバックアップ

- **概念**: 全データの完全バックアップ
- **利点**: シンプル、確実な復旧
- **欠点**: 時間・容量を大量消費
- **頻度**: 週次または月次

増分バックアップ

- **概念**: 前回バックアップからの変更分のみ
- **利点**: 高速、容量効率
- **欠点**: 復旧時に複数バックアップが必要
- **頻度**: 日次または時間次

差分バックアップ

- **概念**: 最後のフルバックアップからの変更分
- **利点**: 復旧が比較的簡単
- **欠点**: 時間経過とともにサイズ増大
- **頻度**: 日次

### 3-2-1 バックアップルール

3つのコピー

- **本番データ**: 運用中のデータ
- **ローカルバックアップ**: 高速復旧用
- **リモートバックアップ**: 災害対策用

2つの異なる媒体

- **ディスク**: 高速アクセス
- **テープ/クラウド**: 長期保存
- **技術多様化**: 単一技術への依存回避

1つのオフサイト

- **地理的分散**: 災害リスクの分散
- **クラウド**: 最も一般的なオフサイト
- **遠隔地**: 物理的に離れた場所

### AWS バックアップサービス

AWS Backup

- **統合管理**: 複数サービスの統一バックアップ
- **ポリシーベース**: 自動化されたバックアップ
- **クロスリージョン**: 地理的分散バックアップ
- **コンプライアンス**: 監査・規制対応

サービス固有バックアップ

- **EBS スナップショット**: ブロックレベルバックアップ
- **RDS 自動バックアップ**: データベースバックアップ
- **S3 レプリケーション**: オブジェクトレベル複製
- **DynamoDB バックアップ**: NoSQL データバックアップ

バックアップ戦略設計

- **保持期間**: 法的要件、ビジネス要件
- **暗号化**: データ保護、コンプライアンス
- **アクセス制御**: バックアップデータの保護
- **コスト最適化**: ストレージクラス、ライフサイクル

---

## 高可用性設計

高可用性を実現するための設計には以下が含まれます：

- **Auto Scaling**: トラフィックの増減に応じてリソースを自動調整。
- **Elastic Load Balancing (ELB)**: トラフィックを複数のインスタンスに分散。
- **Multi-AZ**: データベースの冗長性を確保。

### 単一障害点の排除

コンピューティング層

- **Auto Scaling**: 障害インスタンスの自動置換
- **マルチAZ配置**: 複数可用性ゾーンでの冗長化
- **ロードバランサー**: トラフィック分散、ヘルスチェック
- **コンテナ**: 障害時の迅速な再起動

データ層

- **RDS Multi-AZ**: 自動フェイルオーバー
- **DynamoDB**: 自動的な冗長化
- **ElastiCache**: レプリケーション、クラスタリング
- **S3**: 99.999999999% の耐久性

ネットワーク層

- **複数AZ**: ネットワーク障害の分散
- **冗長接続**: 複数の接続経路
- **DNS フェイルオーバー**: Route 53 ヘルスチェック
- **CDN**: エッジでの障害吸収

### 自動復旧メカニズム

ヘルスチェック

- **アプリケーションレベル**: 業務機能の健全性
- **システムレベル**: OS、ミドルウェアの状態
- **ネットワークレベル**: 通信可能性
- **適切な閾値**: 偽陽性・偽陰性の回避

自動フェイルオーバー

- **データベース**: RDS Multi-AZ、Aurora
- **アプリケーション**: ELB、Auto Scaling
- **DNS**: Route 53 ヘルスチェック
- **ストレージ**: EFS、S3 の自動冗長化

障害分離

- **マイクロサービス**: 障害の局所化
- **サーキットブレーカー**: 障害の連鎖防止
- **バルクヘッド**: リソースの分離
- **タイムアウト**: 無限待機の防止

---

## マルチリージョン設計

マルチリージョン設計では以下を考慮します：

- **Amazon Route 53**: DNSフェイルオーバーを設定。
- **AWS Global Accelerator**: グローバルなアプリケーションのパフォーマンスを向上。
- **Amazon Aurora Global Database**: グローバルなデータベースレプリケーションを提供。

### リージョン選択の考慮事項

地理的要因

- **ユーザー分布**: ユーザーとの地理的距離
- **レイテンシ**: ネットワーク遅延の最小化
- **災害リスク**: 自然災害の地理的分散
- **時差**: 運用時間帯の考慮

法的・規制要因

- **データ主権**: データ保存場所の法的制約
- **プライバシー法**: GDPR、個人情報保護法
- **業界規制**: 金融、医療等の業界固有規制
- **政治的安定性**: 地政学的リスク

技術的要因

- **サービス可用性**: 利用したいサービスの提供状況
- **機能差異**: リージョン間の機能差
- **価格差**: リージョン間の価格差異
- **ネットワーク**: リージョン間接続の品質

### データレプリケーション

同期レプリケーション

- **特徴**: リアルタイムでのデータ同期
- **利点**: データ整合性の確保
- **欠点**: 性能への影響、ネットワーク依存
- **適用**: 金融取引等の厳格な整合性要件

非同期レプリケーション

- **特徴**: 遅延を伴うデータ同期
- **利点**: 性能への影響最小、ネットワーク障害耐性
- **欠点**: データ不整合の可能性
- **適用**: 一般的なWebアプリケーション

レプリケーション戦略

- **Aurora Global Database**: 1秒未満の遅延
- **DynamoDB Global Tables**: マルチマスター
- **S3 Cross-Region Replication**: オブジェクトレベル
- **RDS Read Replica**: 読み取り専用レプリカ

### トラフィック制御

DNS ベースルーティング

- **Latency-based**: レイテンシ最小化
- **Geolocation**: 地理的位置ベース
- **Weighted**: 重み付け負荷分散
- **Health Check**: 障害時の自動切り替え

アプリケーションレベル制御

- **Global Load Balancer**: AWS Global Accelerator
- **CDN**: CloudFront での地理的分散
- **API Gateway**: リージョナルエンドポイント
- **アプリケーション**: 独自のルーティングロジック

---

## 災害復旧の実装パターン

災害復旧の実装には以下のパターンがあります：

- **フェイルオーバー**: 障害発生時に自動的に別のリージョンに切り替え。
- **データレプリケーション**: データを複数のリージョンに同期。
- **テストと検証**: 定期的な災害復旧テストを実施し、計画の有効性を確認。

### データベース災害復旧

RDS 災害復旧

- **Multi-AZ**: 同一リージョン内の高可用性
- **Read Replica**: 読み取り専用レプリカ
- **Cross-Region Replica**: 異なるリージョンへの複製
- **自動バックアップ**: ポイントインタイム復旧

DynamoDB 災害復旧

- **Global Tables**: マルチリージョン、マルチマスター
- **Point-in-Time Recovery**: 35日間の復旧
- **On-Demand Backup**: 手動バックアップ
- **Cross-Region Replication**: カスタム実装

Aurora 災害復旧

- **Aurora Global Database**: 1秒未満のRPO
- **Aurora Serverless**: 自動スケーリング
- **Backtrack**: 72時間以内の巻き戻し
- **Clone**: 高速なデータベース複製

### アプリケーション災害復旧

ステートレス設計

- **外部状態管理**: セッション、キャッシュの外部化
- **イミュータブル**: 不変なアプリケーション設計
- **コンテナ化**: 迅速なデプロイメント
- **マイクロサービス**: 独立した復旧

Infrastructure as Code

- **CloudFormation**: インフラの自動構築
- **CDK**: プログラマティックなインフラ定義
- **Terraform**: マルチクラウド対応
- **バージョン管理**: インフラ設定の履歴管理

CI/CD パイプライン

- **自動デプロイ**: 災害復旧環境への自動展開
- **Blue/Green**: 無停止での環境切り替え
- **Canary**: 段階的な切り替え
- **ロールバック**: 迅速な元環境への復帰

### 監視・テスト

災害復旧監視

- **レプリケーション遅延**: データ同期の監視
- **ヘルスチェック**: 災害復旧環境の健全性
- **RTO/RPO メトリクス**: 目標値の達成状況
- **コスト監視**: 災害復旧環境のコスト

定期テスト

- **復旧テスト**: 実際の復旧手順の検証
- **フェイルオーバーテスト**: 自動切り替えの確認
- **データ整合性テスト**: 復旧データの検証
- **性能テスト**: 復旧環境の性能確認

カオスエンジニアリング

- **障害注入**: 意図的な障害発生
- **システム耐性**: 障害に対する回復力
- **改善点特定**: 弱点の発見・改善
- **継続的改善**: 定期的な耐性向上

---

## まとめ

### 試験でのポイント

災害復旧戦略の選択基準

1. **RTO/RPO要件**: ビジネス要件に応じた目標設定
2. **コスト制約**: 災害復旧投資の適切なバランス
3. **システム特性**: アーキテクチャ、データ特性
4. **規制要件**: 法的・業界固有の要求事項
5. **運用能力**: 組織の技術・運用成熟度

4つの災害復旧パターン

- **Backup and Restore**: 最低コスト、長時間復旧
- **Pilot Light**: 低コスト、中程度復旧時間
- **Warm Standby**: 中コスト、短時間復旧
- **Multi-Site Active/Active**: 高コスト、ほぼゼロ復旧時間

高可用性設計の原則

- **単一障害点排除**: あらゆるレイヤーでの冗長化
- **自動復旧**: 人的介入を最小化した自動化
- **障害分離**: 障害の影響範囲限定
- **継続的テスト**: 定期的な復旧テスト・改善

マルチリージョン設計

- **適切なリージョン選択**: 地理的、法的、技術的考慮
- **データレプリケーション**: 同期・非同期の使い分け
- **トラフィック制御**: DNS、アプリケーションレベル制御
- **整合性管理**: 複数リージョン間のデータ整合性

---

## AWS Elastic Disaster Recovery

AWS Elastic Disaster Recovery (AWS DRS) は、オンプレミスおよびクラウドベースのアプリケーションを迅速かつ確実に復旧するためのサービスです。手頃な料金のストレージ、最小限のコンピューティングリソース、ポイントインタイムリカバリを使用して、ダウンタイムやデータ損失を最小限に抑えます。

### 利点

- **コスト削減**: 手頃な料金のストレージと最小限のコンピューティングリソースを使用。
- **迅速なリカバリ**: 数分以内にリカバリインスタンスを起動可能。
- **統合プロセス**: 無停止テストを実行して準備状態を維持。
- **自動化**: レプリケーションと復旧プロセスを自動化。

### 仕組み

1. ソースサーバーで AWS Elastic Disaster Recovery を設定し、安全なデータレプリケーションを開始。
2. データは選択した AWS リージョンのステージングエリアサブネットにレプリケートされます。
3. ステージングエリアでは、手頃な料金のストレージと最小限のコンピューティングリソースを使用して継続的なレプリケーションを維持。
4. 無停止テストを実行して実装が完了したことを確認。
5. 必要に応じて、最新のサーバー状態または以前の時点を使用してリカバリインスタンスを起動。
6. アプリケーションを AWS で実行するか、プライマリサイトにフェールバック可能。

### ユースケース

- **オンプレミスから AWS**: オンプレミス環境の災害復旧。
- **クラウドから AWS**: 他のクラウド環境からの災害復旧。
- **AWS リージョン間**: AWS リージョン間での災害復旧。

### 公式リソース

- [AWS Elastic Disaster Recovery](https://aws.amazon.com/disaster-recovery/)
- [AWS Well-Architected Reliability Pillar](https://docs.aws.amazon.com/wellarchitected/latest/reliability-pillar/)

---

## ライセンス

このコンテンツは MIT License の下で公開されています。詳細は [LICENSE](./LICENSE) ファイルをご確認ください。
