# ネットワーキング

<!-- 
Copyright (c) 2025 AWS SAP Study Guide
Licensed under the MIT License. See LICENSE file for details.
-->

## 目次

1. [VPC (Virtual Private Cloud)](#vpc-virtual-private-cloud)
2. [接続オプション](#接続オプション)
3. [ロードバランシング](#ロードバランシング)
4. [コンテンツ配信・DNS](#コンテンツ配信dns)
5. [ネットワークセキュリティ](#ネットワークセキュリティ)
6. [ネットワーク設計パターン](#ネットワーク設計パターン)

---

## VPC (Virtual Private Cloud)

### 基本概念と特徴

VPCの位置づけ

- AWS クラウド内の論理的に分離されたネットワーク
- オンプレミスのデータセンターと同様の制御
- セキュリティとネットワーク設定の完全な制御
- 複数のアベイラビリティゾーンにまたがる配置

主要コンポーネント

- **サブネット**: VPC内のIPアドレス範囲の区分
- **ルートテーブル**: トラフィックの経路制御
- **インターネットゲートウェイ**: インターネット接続
- **NAT Gateway/Instance**: プライベートサブネットからの外部接続

### サブネット設計

パブリックサブネット

- **特徴**: インターネットゲートウェイへの経路を持つ
- **用途**: ロードバランサー、Webサーバー、踏み台サーバー
- **セキュリティ**: 最小限のリソース配置、適切なセキュリティグループ
- **設計考慮**: DMZ的な役割、外部からのアクセスポイント

プライベートサブネット

- **特徴**: インターネットゲートウェイへの直接経路なし
- **用途**: アプリケーションサーバー、データベース
- **外部接続**: NAT Gateway経由でのアウトバウンド通信
- **セキュリティ**: 内部リソースの保護、多層防御

データベースサブネット

- **特徴**: 最も制限された環境
- **用途**: RDS、ElastiCache等のデータストア
- **アクセス制御**: アプリケーション層からのみアクセス
- **冗長性**: 複数AZでの配置

### ルーティングとゲートウェイ

インターネットゲートウェイ (IGW)

- **目的**: VPCとインターネット間の通信
- **特徴**: 高可用性、自動スケーリング
- **制限**: VPCあたり1つのみアタッチ可能
- **用途**: パブリックサブネットのインターネット接続

NAT Gateway vs NAT Instance

- **NAT Gateway**: マネージド、高可用性、高性能、コスト高
- **NAT Instance**: 自己管理、カスタマイズ可能、コスト低、運用負荷
- **選択基準**: 運用負荷、コスト、カスタマイズ要件
- **可用性**: NAT Gatewayは単一AZ、冗長化には複数配置必要

VPC Endpoints

- **Gateway Endpoint**: S3、DynamoDB専用、無料
- **Interface Endpoint**: 多数のAWSサービス対応、時間課金
- **目的**: AWS内部通信、データ転送コスト削減
- **セキュリティ**: インターネット経由を避けた安全な通信

### VPC設計のベストプラクティス

IPアドレス設計

- **CIDR選択**: 将来の拡張を考慮した十分なアドレス空間
- **重複回避**: オンプレミス、他VPCとの重複回避
- **サブネット分割**: 用途別、AZ別の適切な分割
- **予約アドレス**: AWS予約分（各サブネット5個）の考慮

マルチAZ設計

- **可用性**: 複数AZでの冗長配置
- **負荷分散**: AZ間でのトラフィック分散
- **災害復旧**: AZ障害時の継続性確保
- **コスト**: AZ間データ転送コストの考慮

### 公式リソース

- [VPC サービス紹介](https://aws.amazon.com/jp/vpc/)
- [VPC Black Belt](https://d1.awsstatic.com/webinars/jp/pdf/services/20201021_AWS-BlackBelt-VPC.pdf)

---

## 接続オプション

### VPC間接続

VPC Peering

- **概念**: 2つのVPC間のプライベート接続
- **特徴**: 1対1接続、推移的ルーティングなし
- **制限**: CIDR重複不可、同一リージョン/クロスリージョン対応
- **用途**: 少数VPC間の直接接続、シンプルな構成

Transit Gateway

- **概念**: 複数VPC、オンプレミスのハブ接続
- **特徴**: スター型トポロジー、集中管理
- **利点**: スケーラビリティ、管理簡素化、推移的ルーティング
- **用途**: 大規模環境、複雑な接続要件

選択基準

- **VPC数**: 少数ならPeering、多数ならTransit Gateway
- **管理複雑性**: Peeringは個別管理、Transit Gatewayは集中管理
- **コスト**: Peeringは無料、Transit Gatewayは時間・データ課金
- **将来性**: 拡張予定があればTransit Gateway

### オンプレミス接続

AWS Site-to-Site VPN

- **概念**: インターネット経由の暗号化接続
- **特徴**: 迅速な導入、低初期コスト、帯域幅制限
- **冗長性**: 2つのVPNトンネル、複数のカスタマーゲートウェイ
- **用途**: 初期接続、バックアップ回線、小規模トラフィック

AWS Direct Connect

- **概念**: 専用線による物理接続
- **特徴**: 安定した帯域、低レイテンシ、高コスト
- **導入期間**: 数週間から数ヶ月
- **用途**: 大容量データ転送、安定した接続、本格運用

Client VPN

- **概念**: リモートユーザー向けVPN
- **特徴**: SSL/TLS、多要素認証、細かいアクセス制御
- **用途**: リモートワーク、管理者アクセス
- **認証**: Active Directory、SAML、証明書ベース

接続選択の指針

- **帯域幅要件**: 大容量ならDirect Connect、小容量ならVPN
- **レイテンシ要件**: 低レイテンシならDirect Connect
- **コスト**: 初期コスト重視ならVPN、運用コスト重視ならDirect Connect
- **導入期間**: 迅速導入ならVPN、計画的導入ならDirect Connect

### ハイブリッド接続パターン

冗長構成

- **Direct Connect + VPN**: 主回線と冗長回線
- **複数Direct Connect**: 異なるロケーションからの接続
- **複数VPN**: 異なるISP経由の接続
- **Transit Gateway**: 統一的な冗長管理

段階的移行

- **Phase 1**: VPNでの初期接続
- **Phase 2**: Direct Connect導入
- **Phase 3**: VPNをバックアップ回線化
- **Phase 4**: 完全なハイブリッド環境

### 公式リソース

- [Transit Gateway サービス紹介](https://aws.amazon.com/jp/transit-gateway/)
- [Transit Gateway Black Belt](https://d1.awsstatic.com/webinars/jp/pdf/services/20191113_AWS-BlackBelt_Transit_Gateway.pdf)
- [Direct Connect サービス紹介](https://aws.amazon.com/jp/directconnect/)
- [Direct Connect Black Belt](https://d1.awsstatic.com/webinars/jp/pdf/services/20210209-AWS-Blackbelt-DirectConnect.pdf)
- [VPN サービス紹介](https://aws.amazon.com/jp/vpn/)
- [VPN Black Belt](https://d1.awsstatic.com/webinars/jp/pdf/services/202110_AWS_Black_Belt_Site-to-Site_VPN.pdf)

---

## ロードバランシング

### Elastic Load Balancer (ELB)

Application Load Balancer (ALB)

- **レイヤー**: Layer 7 (HTTP/HTTPS)
- **特徴**: パス・ホストベースルーティング、WebSocket対応
- **ターゲット**: EC2、IP、Lambda、ECS
- **用途**: Webアプリケーション、マイクロサービス、コンテナ

Network Load Balancer (NLB)

- **レイヤー**: Layer 4 (TCP/UDP)
- **特徴**: 超高性能、静的IP、極低レイテンシ
- **ターゲット**: EC2、IP、ALB
- **用途**: 高性能要件、非HTTP、ゲーム、IoT

Gateway Load Balancer (GWLB)

- **レイヤー**: Layer 3 Gateway + Layer 4 Load Balancing
- **特徴**: サードパーティアプライアンス統合
- **用途**: ファイアウォール、IDS/IPS、DPI
- **アーキテクチャ**: Transparent proxy、GENEVE encapsulation

Classic Load Balancer (CLB)

- **レイヤー**: Layer 4/7 (レガシー)
- **特徴**: 基本的な負荷分散機能
- **推奨**: 新規作成時は他のELBを推奨
- **移行**: ALB/NLBへの移行を検討

### ロードバランサー選択の指針

プロトコル要件

- **HTTP/HTTPS**: ALB
- **TCP/UDP**: NLB
- **混在**: ALB + NLB構成

パフォーマンス要件

- **超高性能**: NLB
- **標準性能**: ALB
- **レイテンシ重視**: NLB

機能要件

- **高度なルーティング**: ALB
- **SSL終端**: ALB、NLB両対応
- **静的IP**: NLB
- **WebSocket**: ALB

### ヘルスチェックと可用性

ヘルスチェック設計

- **チェック間隔**: パフォーマンスと検知速度のバランス
- **閾値設定**: 健全・異常判定の適切な設定
- **チェック内容**: アプリケーションレベルの健全性確認
- **タイムアウト**: ネットワーク状況を考慮した設定

可用性設計

- **マルチAZ**: 複数AZでのターゲット配置
- **Auto Scaling**: 障害時の自動復旧
- **Connection Draining**: 安全なインスタンス切り離し
- **Sticky Session**: セッション維持とスケーラビリティのバランス

### 公式リソース

- [ELB サービス紹介](https://aws.amazon.com/jp/elasticloadbalancing/)
- [ELB Black Belt](https://d1.awsstatic.com/webinars/jp/pdf/services/20191029_AWS-Blackbelt_ELB.pdf)

---

## コンテンツ配信・DNS

### Amazon CloudFront

基本概念

- **CDN**: グローバルなコンテンツ配信ネットワーク
- **エッジロケーション**: 世界中の配信拠点
- **オリジン**: S3、ALB、EC2、カスタムオリジン
- **キャッシュ**: エッジでのコンテンツキャッシュ

主要機能

- **動的・静的コンテンツ**: 両方の配信に対応
- **SSL/TLS**: 証明書管理、HTTP/2対応
- **セキュリティ**: WAF統合、DDoS保護
- **カスタマイズ**: Lambda@Edge、CloudFront Functions

キャッシュ戦略

- **TTL設定**: コンテンツ特性に応じた適切な設定
- **キャッシュキー**: クエリパラメータ、ヘッダーの考慮
- **無効化**: 緊急時のキャッシュクリア
- **圧縮**: 自動圧縮によるパフォーマンス向上

使用場面

- **Webサイト高速化**: 静的コンテンツの配信
- **API高速化**: 動的コンテンツのキャッシュ
- **グローバル展開**: 世界中のユーザーへの配信
- **コスト削減**: オリジンへの負荷軽減

#### 公式リソース

- [CloudFront サービス紹介](https://aws.amazon.com/jp/cloudfront/)
- [CloudFront Black Belt](https://d1.awsstatic.com/webinars/jp/pdf/services/20190730_AWS-BlackBelt_Amazon_CloudFront.pdf)

### Amazon Route 53

基本概念

- **DNS**: ドメイン名解決サービス
- **高可用性**: 100% SLA、グローバル分散
- **統合**: AWSサービスとの深い統合
- **機能**: ドメイン登録、DNS解決、ヘルスチェック

ルーティングポリシー

- **Simple**: 単一リソースへの解決
- **Weighted**: 重み付けによる負荷分散
- **Latency**: レイテンシベースの最適化
- **Failover**: プライマリ・セカンダリ構成
- **Geolocation**: 地理的位置による振り分け
- **Geoproximity**: 地理的近接性とバイアス
- **Multivalue**: 複数IPの返却

ヘルスチェック

- **エンドポイント監視**: HTTP、HTTPS、TCP
- **CloudWatch統合**: メトリクス、アラーム
- **計算ヘルスチェック**: 複数チェックの組み合わせ
- **プライベートリソース**: CloudWatch Alarmベース

使用場面

- **災害復旧**: 自動フェイルオーバー
- **負荷分散**: DNS レベルでの分散
- **グローバル展開**: 地域最適化
- **Blue/Green デプロイ**: 段階的な切り替え

#### 公式リソース

- [Route 53 サービス紹介](https://aws.amazon.com/jp/route53/)
- [Route 53 Black Belt](https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2023_AmazonRoute53-hostedZone_0531_V1.pdf)

---

## ネットワークセキュリティ

### セキュリティグループ vs NACL

セキュリティグループ

- **レベル**: インスタンスレベル
- **ステート**: ステートフル（戻りトラフィック自動許可）
- **ルール**: 許可ルールのみ
- **評価**: すべてのルールを評価
- **用途**: きめ細かいアクセス制御

Network ACL (NACL)

- **レベル**: サブネットレベル
- **ステート**: ステートレス（明示的な許可が必要）
- **ルール**: 許可・拒否ルール
- **評価**: ルール番号順に評価
- **用途**: サブネット間の制御、追加の防御層

設計指針

- **多層防御**: 両方を組み合わせた設計
- **最小権限**: 必要最小限のアクセス許可
- **管理性**: セキュリティグループでの詳細制御
- **緊急対応**: NACLでの迅速な遮断

### AWS WAF

基本概念

- **Web Application Firewall**: アプリケーション層の保護
- **統合**: CloudFront、ALB、API Gateway
- **ルールベース**: カスタムルール、マネージドルール
- **リアルタイム**: 即座の脅威対応

主要機能

- **SQLインジェクション**: データベース攻撃の防御
- **XSS**: クロスサイトスクリプティング対策
- **DDoS**: アプリケーション層DDoS攻撃の軽減
- **Bot対策**: 悪意のあるボットの検知・ブロック

ルール設計

- **マネージドルール**: AWS、サードパーティ提供
- **カスタムルール**: 独自の脅威パターン
- **レート制限**: 過度なリクエストの制限
- **地理的制限**: 特定地域からのアクセス制御

### AWS Shield

Shield Standard

- **対象**: すべてのAWSリソース
- **保護**: Layer 3/4 DDoS攻撃
- **コスト**: 無料
- **機能**: 自動的な攻撃検知・軽減

Shield Advanced

- **対象**: CloudFront、Route 53、ELB、EC2 EIP
- **保護**: 高度なDDoS攻撃、アプリケーション層攻撃
- **コスト**: 月額3,000ドル
- **機能**: 24/7サポート、攻撃分析、コスト保護

選択基準

- **攻撃リスク**: 高リスクならAdvanced
- **ビジネス影響**: ミッションクリティカルならAdvanced
- **コスト**: ROIを考慮した選択
- **サポート**: 専門サポートの必要性

---

## ネットワーク設計パターン

### 3層アーキテクチャ

Web層 (プレゼンテーション層)

- **配置**: パブリックサブネット
- **コンポーネント**: ALB、CloudFront、Web サーバー
- **セキュリティ**: WAF、セキュリティグループ
- **スケーリング**: Auto Scaling、複数AZ

アプリケーション層

- **配置**: プライベートサブネット
- **コンポーネント**: アプリケーションサーバー、API
- **セキュリティ**: セキュリティグループ、IAMロール
- **スケーリング**: Auto Scaling、ロードバランシング

データ層

- **配置**: データベースサブネット
- **コンポーネント**: RDS、DynamoDB、ElastiCache
- **セキュリティ**: 暗号化、アクセス制御
- **可用性**: Multi-AZ、リードレプリカ

### ハブ・スポークモデル

ハブVPC

- **役割**: 共有サービス、セキュリティ統制
- **コンポーネント**: Transit Gateway、共有リソース
- **接続**: オンプレミス、インターネット
- **管理**: 集中的なネットワーク管理

スポークVPC

- **役割**: 個別のワークロード、アプリケーション
- **分離**: ワークロード間の分離
- **接続**: ハブ経由での通信
- **スケーリング**: 独立したスケーリング

利点

- **管理簡素化**: 集中的なネットワーク管理
- **セキュリティ**: 統一されたセキュリティポリシー
- **コスト効率**: 共有リソースの活用
- **スケーラビリティ**: 容易なスポーク追加

### マルチリージョン設計

アクティブ・パッシブ

- **プライマリリージョン**: 通常時のトラフィック処理
- **セカンダリリージョン**: 災害時のフェイルオーバー先
- **データ同期**: 非同期レプリケーション
- **切り替え**: Route 53 ヘルスチェック

アクティブ・アクティブ

- **両リージョン**: 同時にトラフィック処理
- **負荷分散**: 地理的な負荷分散
- **データ同期**: 双方向レプリケーション
- **複雑性**: 高い設計・運用複雑性

設計考慮事項

- **レイテンシ**: ユーザーとの地理的距離
- **データ主権**: 法的・規制要件
- **災害復旧**: RTO/RPO要件
- **コスト**: 複数リージョンの運用コスト

### セキュリティ重視設計

ゼロトラストネットワーク

- **原則**: 信頼の検証、最小権限
- **実装**: マイクロセグメンテーション
- **認証**: 継続的な認証・認可
- **監視**: 全トラフィックの可視化

DMZ設計

- **パブリックDMZ**: インターネット向けサービス
- **プライベートDMZ**: 内部サービス間の通信
- **管理DMZ**: 管理・監視サービス
- **分離**: 各層の適切な分離

監査・コンプライアンス

- **ログ収集**: VPC Flow Logs、DNS Logs
- **監視**: CloudWatch、GuardDuty
- **分析**: 異常検知、脅威分析
- **レポート**: コンプライアンス報告

---

## まとめ

### 試験でのポイント

ネットワーク設計の判断基準

1. **可用性要件**: SLA、災害復旧、冗長性
2. **性能要件**: レイテンシ、スループット、帯域幅
3. **セキュリティ要件**: 分離、暗号化、アクセス制御
4. **コスト要件**: 初期コスト、運用コスト、データ転送コスト
5. **管理要件**: 運用負荷、複雑性、スケーラビリティ

よくある設計パターン

- **3層アーキテクチャ**: Web、App、DB層の分離
- **ハブ・スポーク**: 集中管理と分散ワークロード
- **マルチリージョン**: 災害復旧、グローバル展開
- **ハイブリッド**: オンプレミスとクラウドの統合

サービス選択の指針

- **接続**: VPN vs Direct Connect、Peering vs Transit Gateway
- **ロードバランサー**: ALB vs NLB vs GWLB
- **セキュリティ**: 多層防御、適切なツール選択
- **DNS**: Route 53 ルーティングポリシーの使い分け

運用・最適化

- **監視**: ネットワークパフォーマンス、セキュリティ
- **コスト最適化**: データ転送、適切なサービス選択
- **自動化**: 障害対応、スケーリング
- **継続改善**: 定期的な見直し、最適化

---

## ライセンス

このコンテンツは MIT License の下で公開されています。詳細は [LICENSE](./LICENSE) ファイルをご確認ください。
