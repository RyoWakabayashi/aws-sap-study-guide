# 監視・ログ

<!-- 
Copyright (c) 2025 AWS SAP Study Guide
Licensed under the MIT License. See LICENSE file for details.
-->

## 目次

1. [Amazon CloudWatch](#amazon-cloudwatch)
2. [AWS X-Ray](#aws-x-ray)
3. [ログ管理](#ログ管理)
4. [アプリケーション監視](#アプリケーション監視)
5. [運用監視戦略](#運用監視戦略)
6. [監視設計パターン](#監視設計パターン)

---

## Amazon CloudWatch

### 基本概念と特徴

CloudWatchの役割

- AWSリソースとアプリケーションの統合監視プラットフォーム
- メトリクス収集、ログ管理、アラーム、自動化の統合
- リアルタイム監視と履歴データ分析
- 運用の可視化と自動化の基盤

主要コンポーネント

- **Metrics**: 数値データの時系列収集
- **Logs**: ログデータの収集・分析
- **Alarms**: 閾値ベースのアラート
- **Events/EventBridge**: イベント駆動の自動化
- **Dashboards**: 可視化とレポート

### メトリクス監視

標準メトリクス

- **EC2**: CPU使用率、ネットワーク、ディスクI/O
- **RDS**: 接続数、CPU、読み書きレイテンシ
- **ELB**: リクエスト数、レスポンス時間、エラー率
- **S3**: リクエスト数、エラー、データ転送量

カスタムメトリクス

- **アプリケーション固有**: ビジネスメトリクス
- **詳細監視**: 1分間隔での高頻度監視
- **ディメンション**: メトリクスの分類・フィルタリング
- **統計**: 平均、最大、最小、合計、サンプル数

メトリクス設計の考慮事項

- **粒度**: 監視間隔とコストのバランス
- **保持期間**: データ保持期間とストレージコスト
- **ディメンション**: 適切な分類軸の設定
- **統計**: 用途に応じた統計値の選択

### アラーム設計

アラーム設定の原則

- **アクションにつながるアラート**: 対応可能な問題のみアラート
- **適切な閾値**: 偽陽性・偽陰性の最小化
- **段階的エスカレーション**: 重要度に応じた通知先
- **自動復旧**: 可能な限りの自動対応

アラーム状態

- **OK**: 正常状態
- **ALARM**: 閾値超過状態
- **INSUFFICIENT_DATA**: データ不足状態
- **状態遷移**: 状態変化時のアクション実行

複合アラーム

- **論理演算**: AND、OR、NOTによる条件組み合わせ
- **複雑な条件**: 複数メトリクスの相関監視
- **アラーム疲れ**: 不要なアラートの削減
- **ビジネス影響**: ビジネス観点での重要度設定

### ダッシュボード設計

ダッシュボードの種類

- **運用ダッシュボード**: リアルタイム監視用
- **ビジネスダッシュボード**: KPI・ビジネスメトリクス
- **トラブルシューティング**: 問題分析用
- **エグゼクティブ**: 経営層向けサマリー

効果的なダッシュボード設計

- **階層化**: 概要から詳細への段階的表示
- **関連性**: 相関のあるメトリクスのグループ化
- **時間軸**: 適切な時間範囲の設定
- **自動更新**: リアルタイム性の確保

### 公式リソース

- [CloudWatch サービス紹介](https://aws.amazon.com/jp/cloudwatch/)
- [CloudWatch Black Belt](https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2023_AmazonCloudWatch_0330_v1.pdf)

---

## AWS X-Ray

### 基本概念と特徴

分散トレーシング

- マイクロサービス間のリクエスト追跡
- エンドツーエンドのパフォーマンス可視化
- ボトルネック特定と根本原因分析
- サービス依存関係の可視化

主要コンポーネント

- **トレース**: 単一リクエストの完全な経路
- **セグメント**: サービス内での処理単位
- **サブセグメント**: セグメント内の詳細処理
- **アノテーション**: 検索・フィルタリング用メタデータ

### トレース分析

サービスマップ

- **依存関係**: サービス間の呼び出し関係
- **レスポンス時間**: 各サービスの処理時間
- **エラー率**: サービス別のエラー発生率
- **スループット**: リクエスト処理量

パフォーマンス分析

- **レイテンシ分布**: レスポンス時間の分布
- **ボトルネック特定**: 最も時間のかかる処理
- **エラー分析**: エラーの発生パターン
- **異常検知**: 通常と異なるパフォーマンス

### 統合とサンプリング

サービス統合

- **Lambda**: 自動的なトレース収集
- **EC2**: X-Ray エージェントによる収集
- **ECS/EKS**: コンテナでのトレース収集
- **API Gateway**: APIレベルでのトレース

サンプリング戦略

- **固定レート**: 一定割合でのサンプリング
- **リザーバー**: 最小サンプル数の確保
- **動的サンプリング**: 負荷に応じた調整
- **コスト最適化**: サンプリング率とコストのバランス

### 公式リソース

- [X-Ray サービス紹介](https://aws.amazon.com/jp/xray/)
- [X-Ray Black Belt](https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2023_AWS-X-Ray_0228_v1.pdf)

---

## ログ管理

### CloudWatch Logs

基本機能

- **ログ収集**: 様々なソースからのログ集約
- **リアルタイム監視**: ログストリームのリアルタイム表示
- **検索・フィルタ**: ログデータの検索・分析
- **保持期間**: ログの自動削除・アーカイブ

ロググループ・ストリーム

- **ロググループ**: 関連ログの論理的グループ
- **ログストリーム**: 同一ソースからのログシーケンス
- **保持設定**: グループ単位での保持期間設定
- **暗号化**: KMS暗号化によるログ保護

メトリクスフィルタ

- **ログベースメトリクス**: ログからのメトリクス生成
- **パターンマッチング**: 特定パターンの検出
- **カウント**: エラー発生回数等の集計
- **アラーム連携**: メトリクスベースのアラート

### ログ分析

CloudWatch Insights

- **クエリ言語**: 専用クエリ言語による分析
- **リアルタイム分析**: ログデータのリアルタイム分析
- **可視化**: グラフ・チャートでの結果表示
- **保存クエリ**: 頻繁に使用するクエリの保存

ログ分析パターン

- **エラー分析**: エラーログの傾向分析
- **パフォーマンス分析**: レスポンス時間の分析
- **セキュリティ分析**: 不正アクセスの検知
- **ビジネス分析**: ユーザー行動の分析

### ログ統合・転送

ログソース

- **EC2**: CloudWatch エージェント
- **Lambda**: 自動的なログ収集
- **VPC Flow Logs**: ネットワークトラフィック
- **CloudTrail**: API呼び出しログ

ログ転送・統合

- **Kinesis Data Firehose**: S3、Redshift への転送
- **Elasticsearch**: 高度な検索・分析
- **サードパーティ**: Splunk、Datadog等への統合
- **Lambda**: カスタムログ処理

---

## アプリケーション監視

### Application Performance Monitoring (APM)

パフォーマンス監視の観点

- **レスポンス時間**: エンドユーザー体験
- **スループット**: 処理能力・容量
- **エラー率**: 可用性・品質
- **リソース使用率**: インフラ効率性

監視レイヤー

- **インフラ層**: CPU、メモリ、ネットワーク
- **プラットフォーム層**: OS、ミドルウェア
- **アプリケーション層**: アプリケーション固有メトリクス
- **ビジネス層**: ビジネスKPI、ユーザー体験

### Real User Monitoring (RUM)

CloudWatch RUM

- **実ユーザー監視**: 実際のユーザー体験測定
- **Webバイタル**: Core Web Vitals の監視
- **エラー追跡**: JavaScript エラーの収集
- **セッション分析**: ユーザーセッションの詳細分析

合成監視 vs 実ユーザー監視

- **合成監視**: 定期的な自動テスト、予防的監視
- **実ユーザー監視**: 実際のユーザー体験、事後的分析
- **組み合わせ**: 両方を活用した包括的監視
- **用途**: 異なる目的での使い分け

### データベース監視

RDS Performance Insights

- **データベース負荷**: 待機イベント分析
- **SQLクエリ**: 重いクエリの特定
- **リソース使用率**: CPU、メモリ、I/O
- **履歴分析**: 過去のパフォーマンス傾向

DynamoDB監視

- **スロットリング**: 容量超過の監視
- **レイテンシ**: 読み書きレスポンス時間
- **エラー**: システムエラー、ユーザーエラー
- **容量使用率**: プロビジョンド容量の効率性

---

## 運用監視戦略

### 監視レベルの設計

レベル1: インフラ監視

- **基本メトリクス**: CPU、メモリ、ディスク、ネットワーク
- **可用性**: サービス稼働状況
- **容量**: リソース使用率・残容量
- **自動対応**: Auto Scaling、自動復旧

レベル2: アプリケーション監視

- **APM**: アプリケーションパフォーマンス
- **ビジネスメトリクス**: トランザクション数、売上等
- **ユーザー体験**: レスポンス時間、エラー率
- **依存関係**: 外部サービスとの連携状況

レベル3: ビジネス監視

- **KPI**: 主要業績指標
- **SLA**: サービスレベル目標
- **顧客満足度**: ユーザー体験指標
- **ビジネス影響**: 収益・コストへの影響

### アラート戦略

アラート分類

- **P1 (Critical)**: 即座の対応が必要
- **P2 (High)**: 数時間以内の対応
- **P3 (Medium)**: 営業時間内の対応
- **P4 (Low)**: 計画的な対応

通知チャネル

- **即時通知**: SMS、電話、Slack
- **定期レポート**: メール、ダッシュボード
- **エスカレーション**: 段階的な通知先拡大
- **抑制**: 重複アラートの削減

### 運用自動化

自動対応パターン

- **Auto Scaling**: 負荷に応じたスケーリング
- **自動復旧**: 障害インスタンスの置換
- **自動パッチ**: セキュリティパッチの適用
- **バックアップ**: 定期的なデータバックアップ

EventBridge活用

- **イベント駆動**: 状態変化に応じた自動処理
- **ルーティング**: 適切な処理先への振り分け
- **変換**: イベントデータの変換・加工
- **統合**: 外部システムとの連携

---

## 監視設計パターン

### 階層化監視

ピラミッド型監視

- **基盤層**: インフラ・プラットフォーム監視
- **アプリケーション層**: アプリケーション固有監視
- **ビジネス層**: ビジネス価値の監視
- **統合**: 各層の相関分析

サービス指向監視

- **サービス単位**: マイクロサービス毎の監視
- **依存関係**: サービス間の影響分析
- **エンドツーエンド**: ユーザージャーニー全体
- **SLI/SLO**: サービスレベル指標・目標

### 可観測性 (Observability)

3つの柱

- **メトリクス**: 数値データによる状態把握
- **ログ**: 詳細な実行履歴
- **トレース**: 分散システムでのリクエスト追跡

相関分析

- **メトリクス相関**: 複数メトリクスの関係性
- **ログ相関**: 関連ログの統合分析
- **トレース相関**: 分散処理の全体像
- **時系列相関**: 時間軸での因果関係

### コスト効率的な監視

監視コスト最適化

- **メトリクス選択**: 必要なメトリクスのみ収集
- **保持期間**: 適切なデータ保持期間
- **サンプリング**: 統計的に有意なサンプリング
- **アーカイブ**: 長期保存データの低コスト化

ROI重視の監視

- **ビジネス価値**: 監視によるビジネス価値
- **予防効果**: 障害予防による損失回避
- **効率化**: 運用効率化による工数削減
- **継続改善**: 監視データによる改善活動

### セキュリティ監視

セキュリティイベント監視

- **不正アクセス**: 異常なログインパターン
- **権限昇格**: 通常と異なる権限使用
- **データアクセス**: 機密データへの異常アクセス
- **ネットワーク**: 不審な通信パターン

統合セキュリティ監視

- **SIEM**: セキュリティ情報・イベント管理
- **脅威インテリジェンス**: 既知の脅威情報
- **行動分析**: ユーザー・エンティティ行動分析
- **自動対応**: セキュリティインシデントの自動対応

---

## まとめ

### 試験でのポイント

監視設計の判断基準

1. **監視目的**: 可用性、性能、セキュリティ、コスト
2. **監視対象**: インフラ、アプリケーション、ビジネス
3. **監視レベル**: 詳細度と粒度の適切な設定
4. **アラート戦略**: 重要度に応じた通知・対応
5. **コスト効率**: 監視コストとビジネス価値のバランス

よくある監視パターン

- **階層化監視**: インフラからビジネスまでの段階的監視
- **サービス指向**: マイクロサービス単位での監視
- **可観測性**: メトリクス、ログ、トレースの統合
- **自動化**: イベント駆動の自動対応

CloudWatch活用のベストプラクティス

- **適切なメトリクス**: 必要十分なメトリクス選択
- **効果的なアラーム**: アクションにつながるアラート
- **ダッシュボード**: 役割に応じた可視化
- **ログ分析**: Insights による高度な分析

運用監視の成熟度

- **レベル1**: 基本的なインフラ監視
- **レベル2**: アプリケーション・ビジネス監視
- **レベル3**: 予測的監視・自動対応
- **レベル4**: AI/ML による高度な分析・最適化

---

## ライセンス

このコンテンツは MIT License の下で公開されています。詳細は [LICENSE](./LICENSE) ファイルをご確認ください。
