#!/usr/bin/env node

/**
 * ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * - ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–
 * - æœ¬ç•ªç”¨è¨­å®šã®é©ç”¨
 * - ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç”Ÿæˆ
 */

const fs = require('fs')
const path = require('path')
const chalk = require('chalk')

console.log(chalk.blue('ğŸ”¨ Building AWS SAP Quiz Game...'))

const sourceDir = path.join(__dirname, '..')
const buildDir = path.join(__dirname, '..', 'dist')

// ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
if (fs.existsSync(buildDir)) {
  fs.rmSync(buildDir, { recursive: true })
}
fs.mkdirSync(buildDir, { recursive: true })

// ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
const filesToCopy = [
  'index.html',
  'styles.css',
  'script.js',
  'questions.js',
  'manifest.json',
  'sw.js',
  'README.md'
]

console.log(chalk.gray('ğŸ“ Copying files...'))

filesToCopy.forEach((file) => {
  const sourcePath = path.join(sourceDir, file)
  const destPath = path.join(buildDir, file)

  if (fs.existsSync(sourcePath)) {
    let content = fs.readFileSync(sourcePath, 'utf8')

    // ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã®æœ€é©åŒ–å‡¦ç†
    if (file === 'index.html') {
      // HTMLã®æœ€é©åŒ–
      content = optimizeHTML(content)
    } else if (file === 'styles.css') {
      // CSSã®æœ€é©åŒ–
      content = optimizeCSS(content)
    } else if (file === 'script.js') {
      // JavaScriptã®æœ€é©åŒ–
      content = optimizeJS(content)
    } else if (file === 'sw.js') {
      // Service Workerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥åã‚’æ›´æ–°
      content = updateServiceWorker(content)
    }

    fs.writeFileSync(destPath, content)
    console.log(chalk.green(`âœ… ${file}`))
  } else {
    console.log(chalk.yellow(`âš ï¸  ${file} not found, skipping`))
  }
})

// HTMLã®æœ€é©åŒ–
function optimizeHTML (content) {
  // ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤ï¼ˆãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±ã¯ä¿æŒï¼‰
  content = content.replace(/<!--(?!\s*Copyright)[\s\S]*?-->/g, '')

  // ä½™åˆ†ãªç©ºç™½ã®å‰Šé™¤
  content = content.replace(/\s+/g, ' ')
  content = content.replace(/>\s+</g, '><')

  // æœ¬ç•ªç”¨ã®è¨­å®š
  content = content.replace(
    '<meta name="description" content="AWS Solution Architect Professionalè©¦é¨“å¯¾ç­–ã®ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ã‚¤ã‚ºã‚²ãƒ¼ãƒ ">',
    '<meta name="description" content="AWS Solution Architect Professionalè©¦é¨“å¯¾ç­–ã®ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ã‚¤ã‚ºã‚²ãƒ¼ãƒ  - 100å•ä»¥ä¸Šã®4æŠã‚¯ã‚¤ã‚ºã§åŠ¹ç‡çš„ã«å­¦ç¿’">'
  )

  return content.trim()
}

// CSSã®æœ€é©åŒ–
function optimizeCSS (content) {
  // ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤ï¼ˆãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±ã¯ä¿æŒï¼‰
  content = content.replace(/\/\*(?!\s*Copyright)[\s\S]*?\*\//g, '')

  // ä½™åˆ†ãªç©ºç™½ã®å‰Šé™¤
  content = content.replace(/\s+/g, ' ')
  content = content.replace(/;\s*}/g, '}')
  content = content.replace(/{\s*/g, '{')
  content = content.replace(/;\s*/g, ';')

  return content.trim()
}

// JavaScriptã®æœ€é©åŒ–
function optimizeJS (content) {
  // ãƒ‡ãƒãƒƒã‚°ç”¨ã®console.logã‚’å‰Šé™¤ï¼ˆã‚¨ãƒ©ãƒ¼ç³»ã¯ä¿æŒï¼‰
  content = content.replace(/console\.log\([^)]*\);?\n?/g, '')

  // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®ç„¡åŠ¹åŒ–
  content = content.replace(
    'this.debugMode = this.isDebugMode()',
    'this.debugMode = false'
  )

  // ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã®å‰Šé™¤
  content = content.replace(/if \(this\.debugMode\) \{[\s\S]*?\}/g, '')

  return content
}

// Service Workerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥åæ›´æ–°
function updateServiceWorker (content) {
  const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '')
  content = content.replace(
    /const CACHE_NAME = '[^']*'/,
    `const CACHE_NAME = 'aws-sap-quiz-${timestamp}'`
  )
  return content
}

// ãƒ“ãƒ«ãƒ‰æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
const buildInfo = {
  buildTime: new Date().toISOString(),
  version: require('../package.json').version,
  files: filesToCopy.filter((file) =>
    fs.existsSync(path.join(sourceDir, file))
  )
}

fs.writeFileSync(
  path.join(buildDir, 'build-info.json'),
  JSON.stringify(buildInfo, null, 2)
)

// ãƒ“ãƒ«ãƒ‰çµ±è¨ˆã®è¡¨ç¤º
console.log('\n' + chalk.blue('ğŸ“Š Build Statistics:'))
console.log(chalk.gray('â”€'.repeat(50)))

const totalSize = filesToCopy.reduce((total, file) => {
  const filePath = path.join(buildDir, file)
  if (fs.existsSync(filePath)) {
    const size = fs.statSync(filePath).size
    const sizeKB = Math.round(size / 1024)
    console.log(
      chalk.gray(`${file.padEnd(20)} ${sizeKB.toString().padStart(6)} KB`)
    )
    return total + size
  }
  return total
}, 0)

const totalSizeKB = Math.round(totalSize / 1024)
console.log(chalk.gray('â”€'.repeat(50)))
console.log(chalk.blue(`Total size: ${totalSizeKB} KB`))

console.log('\n' + chalk.green('âœ… Build completed successfully!'))
console.log(chalk.gray(`ğŸ“ Build output: ${buildDir}`))
console.log(chalk.gray(`ğŸ•’ Build time: ${new Date().toLocaleString()}`))

// GitHub Pagesç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
const githubPagesConfig = `# GitHub Pages Configuration
# This file is automatically generated during build

# Custom domain (uncomment and modify if needed)
# your-domain.com

# Build info
# Built at: ${new Date().toISOString()}
# Version: ${buildInfo.version}
`

fs.writeFileSync(path.join(buildDir, '.nojekyll'), '')
fs.writeFileSync(path.join(buildDir, 'CNAME.example'), githubPagesConfig)
